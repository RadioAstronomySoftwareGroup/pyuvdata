version: 2
jobs:
  hera_cal:
    docker:
      - image: continuumio/miniconda:latest
    environment:
      PYTHON: "3.6"
      ENV_NAME: "hera_cal-test"
    steps:
      - checkout
      - restore_cache:
          key: deps-{{ .Branch }}-3.6-{{ checksum "ci/environment-3.6.yml" }}
      - run:
          command: |
            conda config --set always_yes yes --set changeps1 no
            conda install -q conda
            conda update -q conda
            conda config --add channels conda-forge
            conda info -a
            conda create -q -n test-${ENV_NAME} python=$PYTHON
            source activate ${ENV_NAME}
            conda install numpy scipy astropy nose pip matplotlib coverage pandas scikit-learn h5py six healpy aipy
            pip install git+https://github.com/HERA-Team/linsolve.git
            pip install git+https://github.com/HERA-Team/hera_qm.git
            pip install git+https://github.com/HERA-Team/uvtools.git
            pip install .
      - run:
          command: |
            source activate ${ENV_NAME}
            cd ../
            git clone git@github.com:HERA-Team/hera_cal.git
            cd hera_cal
            mkdir test-reports
            nosetests hera_cal --with-xunit --xunit-file=test-reports/xunit.xml
      - save_cache:
          key: deps-{{ .Branch }}-3.6-{{ checksum "ci/environment-3.6.yml" }}
          paths:
            - "/opt/conda/envs/${ENV_NAME}/"
      - store_test_results:
          path: hera_cal/test-reports
      - store_artifacts:
          path: hera_cal/test-reports


workflows:
  version: 2
  build_and_test:
    jobs:
      - hera_cal
